document.addEventListener('DOMContentLoaded', function() {
    // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    createSimpleControls();
    initLanguage();
    initSearch();
});

function createSimpleControls() {
    const nav = document.querySelector('nav ul');
    if (!nav) return;

    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    const controlsContainer = document.createElement('li');
    controlsContainer.className = 'nav-controls-container';
    controlsContainer.innerHTML = `
        <div class="nav-controls">
            <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —è–∑—ã–∫–æ–≤ -->
            <div class="language-switcher">
                <button class="lang-toggle" aria-label="–í—ã–±—Ä–∞—Ç—å —è–∑—ã–∫">
                    <span class="lang-flag">${getCurrentLanguageFlag()}</span>
                    <span class="current-lang">${getCurrentLanguageName()}</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="lang-dropdown" role="menu">
                    <a href="?lang=ru" class="lang-option ${document.documentElement.lang === 'ru' ? 'active' : ''}" role="menuitem">
                        <span class="lang-flag">üá∑üá∫</span>
                        <span>–†—É—Å—Å–∫–∏–π</span>
                    </a>
                    <a href="?lang=en" class="lang-option ${document.documentElement.lang === 'en' ? 'active' : ''}" role="menuitem">
                        <span class="lang-flag">üá¨üáß</span>
                        <span>English</span>
                    </a>
                    <a href="?lang=inh" class="lang-option ${document.documentElement.lang === 'inh' ? 'active' : ''}" role="menuitem">
                        <span class="lang-flag">‚ö™</span>
                        <span>–ì”Ä–∞–ª–≥”Ä–∞–π</span>
                    </a>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞ -->
            <button class="enhanced-btn search-toggle-btn" aria-label="–û—Ç–∫—Ä—ã—Ç—å –ø–æ–∏—Å–∫">
                <i class="fas fa-search"></i>
            </button>
        </div>
    `;
    
    nav.appendChild(controlsContainer);
    
    // –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º—É –ø–æ–∏—Å–∫–∞
    createSearchForm();
}

function getCurrentLanguageFlag() {
    const lang = document.documentElement.lang || 'ru';
    const flags = { 'ru': 'üá∑üá∫', 'en': 'üá¨üáß', 'inh': '‚ö™' };
    return flags[lang] || 'üá∑üá∫';
}

function getCurrentLanguageName() {
    const lang = document.documentElement.lang || 'ru';
    const names = { 'ru': '–†–£–°', 'en': 'ENG', 'inh': '–ò–ù–ì' };
    return names[lang] || '–†–£–°';
}

function createSearchForm() {
    const navContainer = document.querySelector('nav');
    if (!navContainer) return;
    
    const searchForm = document.createElement('div');
    searchForm.className = 'nav-search-form';
    searchForm.innerHTML = `
        <div class="nav-search-container">
            <input type="text" class="nav-search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Å–∞–π—Ç—É..." aria-label="–ü–æ–∏—Å–∫ –ø–æ —Å–∞–π—Ç—É">
            <button class="nav-search-close enhanced-btn" aria-label="–ó–∞–∫—Ä—ã—Ç—å –ø–æ–∏—Å–∫">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="nav-search-results"></div>
    `;
    
    navContainer.appendChild(searchForm);
}

function initLanguage() {
    const langOptions = document.querySelectorAll('.lang-option');
    
    langOptions.forEach(option => {
        option.addEventListener('click', function(e) {
            e.preventDefault();
            const lang = new URL(this.href).searchParams.get('lang');
            document.cookie = `lang=${lang};path=/;max-age=31536000`;
            window.location.href = this.href;
        });
    });
}

function initSearch() {
    const searchToggle = document.querySelector('.search-toggle-btn');
    const searchForm = document.querySelector('.nav-search-form');
    const searchClose = document.querySelector('.nav-search-close');
    const searchInput = document.querySelector('.nav-search-input');
    const searchResults = document.querySelector('.nav-search-results');
    
    if (!searchToggle || !searchForm) return;
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ–∏—Å–∫–∞
    searchToggle.addEventListener('click', function(e) {
        e.preventDefault();
        searchForm.classList.add('active');
        setTimeout(() => searchInput.focus(), 100);
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ–∏—Å–∫–∞
    if (searchClose) {
        searchClose.addEventListener('click', function() {
            searchForm.classList.remove('active');
            searchInput.value = '';
            searchResults.innerHTML = '';
        });
    }
    
    // –ü–æ–∏—Å–∫
    let searchTimeout;
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                performSearch(e.target.value);
            }, 300);
        });
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && searchForm.classList.contains('active')) {
            searchForm.classList.remove('active');
            searchInput.value = '';
            searchResults.innerHTML = '';
        }
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ —Ñ–æ—Ä–º—ã
    document.addEventListener('click', function(e) {
        if (!searchForm.contains(e.target) && !searchToggle.contains(e.target)) {
            searchForm.classList.remove('active');
        }
    });
}

async function performSearch(query) {
    const searchResults = document.querySelector('.nav-search-results');
    if (!searchResults) return;
    
    if (!query.trim()) {
        searchResults.innerHTML = '';
        return;
    }
    
    try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
        const results = await response.json();
        
        if (results.length === 0) {
            searchResults.innerHTML = '<div class="search-no-results">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
        } else {
            searchResults.innerHTML = results.map(result => `
                <a href="${result.url}" class="nav-search-result">
                    <div class="search-result-title">${result.title}</div>
                    ${result.snippet ? `<div class="search-result-snippet">${result.snippet}</div>` : ''}
                </a>
            `).join('');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
        searchResults.innerHTML = '<div class="search-error">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
    }
}